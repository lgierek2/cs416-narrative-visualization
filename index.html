<script>
    var currentSlide = 1;
    var margin = { top: 50, right: 150, bottom: 120, left: 150 };
    const width = 2000 - margin.left - margin.right;
    const height = 800 - margin.top - margin.bottom;

    const dataURL = "https://raw.githubusercontent.com/lgierek2/cs416-narrative-visualization/main/us-states.csv";
    const mapURL = "https://raw.githubusercontent.com/lgierek2/cs416-narrative-visualization/main/us-map.json";

    const yAxisDomains = [
        [0, 3000000],   // 0 - GDP
        [0, 30],        // 1 - Inflation
        [0, 50]         // 2 - Interest Rate
    ];
    const yAxisLabels = [
        "States Affected by COVID",
        "Cases and Deaths Over Time",
        "Detailed State Comparison"
    ];
    const xAxisLabel = "Year";

    // Load and render data
    d3.csv(dataURL).then(function(data) {
        d3.json(mapURL).then(function(geojson) {
            renderSlide(currentSlide, data, geojson);
        });
    });

    function renderSlide(slideNumber, data, geojson) {
        d3.select("#myData svg").remove();
        const svg = d3.select("#myData")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        if (slideNumber === 1) {
            // Define color scale for heatmap
            const colorScale = d3.scaleSequential(d3.interpolateReds)
                .domain([0, d3.max(data, d => +d.cases)]);

            // Define projection and path
            const projection = d3.geoAlbersUsa()
                .translate([width / 2, height / 2])
                .scale([1000]);

            const path = d3.geoPath().projection(projection);

            // Merge data with map
            const stateData = new Map(data.map(d => [d.state, +d.cases]));
            geojson.features.forEach(feature => {
                feature.properties.cases = stateData.get(feature.properties.name) || 0;
            });

            // Draw map
            svg.selectAll("path")
                .data(geojson.features)
                .enter().append("path")
                .attr("d", path)
                .attr("fill", d => colorScale(d.properties.cases))
                .attr("stroke", "#fff")
                .attr("stroke-width", 1);

            // Add legend
            const legendWidth = 200;
            const legendHeight = 10;
            const legend = svg.append("g")
                .attr("transform", `translate(${width - 250},${height - 50})`);

            const legendScale = d3.scaleLinear()
                .domain([0, d3.max(data, d => +d.cases)])
                .range([0, legendWidth]);

            legend.selectAll("rect")
                .data(d3.range(legendWidth))
                .enter().append("rect")
                .attr("x", d => legendScale(d))
                .attr("width", legendWidth / d3.range(legendWidth).length)
                .attr("height", legendHeight)
                .attr("fill", d => colorScale(d));

            legend.append("text")
                .attr("x", legendWidth / 2)
                .attr("y", legendHeight + 15)
                .style("text-anchor", "middle")
                .text("Cases");
        } else {
            // Your other slides code
        }

        d3.select("#graphDescriptionText").text(yAxisLabels[slideNumber - 1]);
    }

    function changeSlide(slideNumber) {
        currentSlide = slideNumber;
        d3.csv(dataURL).then(function(data) {
            d3.json(mapURL).then(function(geojson) {
                renderSlide(currentSlide, data, geojson);
            });
        });
    }

    function nextSlide() {
        currentSlide = (currentSlide % 5) + 1;
        d3.csv(dataURL).then(function(data) {
            d3.json(mapURL).then(function(geojson) {
                renderSlide(currentSlide, data, geojson);
            });
        });
    }
</script>
