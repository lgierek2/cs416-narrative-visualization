<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COVID-19 Heatmap by State</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        .cell {
            stroke: #fff;
        }
        .axis text {
            font-size: 12px;
        }
        .color-legend {
            font-size: 12px;
        }
        #map {
            width: 100%;
            height: 600px;
        }
    </style>
</head>
<body>
    <header>
        <span class="mainTitle">Comparative Analysis of COVID-19 Impact Across States</span>
        <div class="pagination">
            <ul id="mainMenu">
                <li><a href="#" id="Slide1" onclick="changeSlide(1)">COVID-19 Heatmap</a></li>
                <!-- Add other slides here -->
            </ul>
        </div>
        <span id="graphDescriptionText" class="graphOrientations"></span>
    </header>
    <main id="map"></main>

    <!-- Load D3.js and topojson -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <script>
        const dataURL = "https://raw.githubusercontent.com/lgierek2/cs416-narrative-visualization/main/us-states.csv";
        const geojsonURL = "https://raw.githubusercontent.com/PublicaMundi/MappingAPI/master/data/geojson/us-states.geojson"; // URL to US states GeoJSON

        const width = 1200;
        const height = 600;

        const svg = d3.select("#map")
            .append("svg")
            .attr("width", width)
            .attr("height", height);

        const projection = d3.geoAlbersUsa()
            .translate([width / 2, height / 2])
            .scale([1000]);

        const path = d3.geoPath().projection(projection);

        // Load GeoJSON and data
        Promise.all([
            d3.json(geojsonURL),
            d3.csv(dataURL)
        ]).then(function([geojson, data]) {
            // Convert data to a usable format
            const stateData = data.map(d => ({
                state: d.state,
                cases: +d.cases // or use 'deaths' if that's your metric
            }));

            const stateCases = {};
            stateData.forEach(d => {
                stateCases[d.state] = d.cases;
            });

            // Create color scale
            const maxCases = d3.max(stateData, d => d.cases);
            const colorScale = d3.scaleSequential(d3.interpolateReds)
                .domain([0, maxCases]);

            // Draw map
            svg.selectAll("path")
                .data(geojson.features)
                .enter().append("path")
                .attr("d", path)
                .attr("fill", d => {
                    const state = d.properties.name;
                    return colorScale(stateCases[state] || 0);
                })
                .attr("stroke", "#fff")
                .attr("stroke-width", 1);

            // Add color legend
            const legendWidth = 300;
            const legendHeight = 20;
            const legend = svg.append("g")
                .attr("transform", `translate(${width - 350},${height - 100})`)
                .attr("class", "color-legend");

            const legendScale = d3.scaleLinear()
                .domain([0, maxCases])
                .range([0, legendWidth]);

            const legendAxis = d3.axisBottom(legendScale)
                .ticks(5)
                .tickFormat(d3.format(".0s"));

            legend.append("rect")
                .attr("x", 0)
                .attr("y", 0)
                .attr("width", legendWidth)
                .attr("height", legendHeight)
                .style("fill", "url(#gradient)");

            svg.append("defs")
                .append("linearGradient")
                .attr("id", "gradient")
                .attr("x1", "0%")
                .attr("y1", "0%")
                .attr("x2", "100%")
                .attr("y2", "0%")
                .selectAll("stop")
                .data([
                    { offset: "0%", color: colorScale(0) },
                    { offset: "100%", color: colorScale(maxCases) }
                ])
                .enter().append("stop")
                .attr("offset", d => d.offset)
                .attr("stop-color", d => d.color);

            legend.append("g")
                .attr("class", "legend-axis")
                .attr("transform", `translate(0,${legendHeight})`)
                .call(legendAxis);
        });
    </script>
</body>
</html>
